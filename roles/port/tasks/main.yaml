---
- name: Prepare node required network info
  set_fact:
    nodes_name: |
      [
        {% for node in nodes %}
        "{{ node.keys()[0] }}",
        {% endfor %}
      ]
    network_require: "['ctlplane'] + {{ role_used_network[role] }}"
  when: action != 'destroy'

# network sequence: ctlplane, internal, external, octavia, storage, tunnel
- name: Prepare node required ip info
  set_fact:
    node_use_ip: |
      [
      {% for name in nodes_name %}
        {{ '{' }}
        'name': '{{ name }}',
        {% if networks.ctlplane.hosts is defined %}
        'ctlplane': '{{ networks.ctlplane.hosts[name] | default('random') }}',
        {% else %}
        'ctlplane': 'random',
        {% endif %}
        {% for net in network_require %}
            {% if networks[net].hosts is defined %}
            '{{ net }}': '{{ networks[net].hosts[name] | default('random') }}',
            {% else %}
            '{{ net }}': 'random',
            {% endif %}
        {% endfor %}
      {{ '}' }},
      {% endfor %}
      ]
  when: action != 'destroy'

- include_tasks: "{{ action }}.yaml"
  with_items: "{{ node_use_ip }}"
  when: action != 'destroy'

- include_tasks: destroy.yaml
  when: action == 'destroy'
